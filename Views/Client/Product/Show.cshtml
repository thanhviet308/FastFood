@using FastFoodShop.Domain.Entities
@model IEnumerable<Product>
@{
    ViewData["Title"] = "Thực Đơn - FastFood Shop";

    Layout = null;
}
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@{
    var af = Xsrf.GetAndStoreTokens(Context);
}
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var isAuth = User?.Identity?.IsAuthenticated == true;
    var sumCart = HttpContextAccessor.HttpContext?.Session.GetInt32("sum") ?? 0;
    var categories = ViewBag.Categories as IEnumerable<Category> ?? new List<Category>();
    var products = Model ?? Enumerable.Empty<Product>();
    long? selectedCategoryId = ViewBag.SelectedCategoryId != null ? (long)ViewBag.SelectedCategoryId : (long?)null;
    var hasProducts = products.Any();
}

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet" />

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Libraries Stylesheet -->
    <link href="~/client/lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
    <link href="~/client/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="~/client/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/client/css/style.css" rel="stylesheet" />
    <!-- FastFood Theme Stylesheet -->
    <link href="~/client/css/fastfood-theme.css" rel="stylesheet" />
    <!-- Minimal Theme Stylesheet - Enhanced Header/Footer -->
    <link href="~/client/css/minimal-theme.css" rel="stylesheet" />

    <!-- jQuery Toast -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css"
        rel="stylesheet" />

    <meta name="X-CSRF-TOKEN" content="@af.RequestToken" />
</head>

<body>
    <!-- Spinner Start -->
    <div id="spinner"
        class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" role="status"></div>
    </div>
    <!-- Spinner End -->

    @await Html.PartialAsync("~/Views/Client/Layout/_Header.cshtml")

    <!-- FastFood Menu Header Start -->
    <div class="container-fluid py-5"
        style="background: linear-gradient(135deg, var(--ff-primary) 0%, var(--ff-secondary) 100%);">
        <div class="container py-5 text-center text-white">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fa-solid fa-utensils me-3"></i>Thực Đơn
            </h1>
            <p class="lead mb-0">Khám phá hàng trăm món ăn ngon tại FastFood Shop</p>
            <nav aria-label="breadcrumb" class="d-flex justify-content-center mt-3">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/" class="text-white text-decoration-none">Trang chủ</a></li>
                    <li class="breadcrumb-item active text-white-50" aria-current="page">Thực đơn</li>
                </ol>
            </nav>
        </div>
    </div>
    <!-- FastFood Menu Header End -->

    <!-- FastFood Menu Content Start -->
    <div class="container-fluid py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        <div class="container py-5">
            <!-- Filter Section -->
            <div class="row mb-5">
                <div class="col-lg-12">
                    <div class="ff-filter-section">
                        <div class="d-flex flex-wrap justify-content-center gap-3 mb-4">
                            <button class="ff-btn-filter active" data-filter="all">Tất cả</button>
                            <button class="ff-btn-filter" data-filter="featured">Nổi bật</button>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-lg-4">
                                <select class="form-select ff-form-select" id="categorySelect">
                                    <option value="">Danh mục</option>
                                    @foreach (var category in categories)
                                    {
                                        var isSelected = selectedCategoryId.HasValue && selectedCategoryId == category.Id;
                                        <option value="@category.Id" selected="@(isSelected ? "selected" : null)">
                                            @category.Name
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-12 col-lg-8">
                                <div class="input-group">
                                    <input type="text" class="form-control ff-form-input"
                                        placeholder="Tìm kiếm món ăn..." id="searchInput">
                                    <button class="ff-btn-primary" type="button" id="searchBtn">
                                        <i class="fa-solid fa-magnifying-glass"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Products Grid -->
            <div class="row g-4 justify-content-center" id="productsContainer">
                @foreach (var product in products)
                {
                    <div class="col-md-6 col-lg-4 col-xl-3 product-item" data-category="@product.CategoryId"
                        data-featured="@product.IsFeatured.ToString().ToLower()">
                        <div class="ff-product-card h-100">
                            <div class="ff-product-image">
                                @if (!string.IsNullOrEmpty(product.Image))
                                {
                                    <img src="@Url.Content("~/images/product/" + product.Image)" alt="@product.Name" class="img-fluid"
                                        onerror="this.src='https://placehold.co/300x200?text=%F0%9F%8D%94&background=f8f9fa&text=888888'" />
                                }
                                else
                                {
                                    <img src="https://placehold.co/300x200?text=%F0%9F%8D%94&background=f8f9fa&text=888888"
                                        alt="@product.Name" class="img-fluid" />
                                }
                                @if (product.IsFeatured)
                                {
                                    <div class="ff-product-badge">NỔI BẬT</div>
                                }
                            </div>
                            <div class="ff-product-content">
                                <h4 class="ff-product-title">
                                    <a asp-controller="Item" asp-action="GetProductPage" asp-route-id="@product.Id"
                                        class="text-decoration-none">
                                        @product.Name
                                    </a>
                                </h4>
                                <p class="ff-product-description">@product.ShortDesc</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="ff-product-price">
                                        <span class="text-muted">Xem chi tiết</span>
                                    </div>
                                </div>
                                <button data-product-id="@product.Id" class="btnAddToCartHomepage ff-product-cart-btn"
                                    aria-label="Thêm vào giỏ hàng">
                                    <i class="fas fa-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="col-12 text-center text-muted mt-4" id="noProductsMessage"
                style="display:@(hasProducts ? "none" : "block");">
                Không có sản phẩm nào khớp với bộ lọc hiện tại.
            </div>

            <!-- Pagination -->
            @if (ViewBag.ShowAll == null || ViewBag.ShowAll == false)
            {
                @if (ViewBag.TotalPages > 1)
                {
                    <div class="col-12">
                        <div class="ff-pagination-wrapper mt-5">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    @if (ViewBag.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="?page=@(ViewBag.CurrentPage - 1)@ViewBag.QueryString"
                                                aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    }

                                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                    {
                                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                            <a class="page-link" href="?page=@i@ViewBag.QueryString">@i</a>
                                        </li>
                                    }

                                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="?page=@(ViewBag.CurrentPage + 1)@ViewBag.QueryString"
                                                aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12 text-center mt-4">
                    <a href="/products" class="ff-btn-primary">Quay lại trang có phân trang</a>
                </div>
            }
        </div>
    </div>
    <!-- FastFood Menu Content End -->

    @await Html.PartialAsync("~/Views/Client/Layout/_Footer.cshtml")

    <!-- Back to Top -->
    <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top" style="display:none">
        <i class="fa fa-arrow-up"></i>
    </a>

    <!-- Variant Selection Modal -->
    <div class="modal fade" id="variantModal" tabindex="-1" aria-labelledby="variantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content ff-modal-content">
                <div class="modal-header ff-modal-header">
                    <h5 class="modal-title" id="variantModalLabel">Chọn loại sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body ff-modal-body">
                    <div id="variantModalContent">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer ff-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="ff-btn-primary" id="confirmAddToCart">Thêm vào giỏ hàng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/client/lib/easing/easing.min.js"></script>
    <script src="~/client/lib/waypoints/waypoints.min.js"></script>
    <script src="~/client/lib/lightbox/js/lightbox.min.js"></script>
    <script src="~/client/lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="~/client/js/main.js?v=20241119"></script>

    <!-- jQuery Toast -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>

    <script>
        // Spinner
        var spinner = function () {
            setTimeout(function () {
                if ($('#spinner').length > 0) {
                    $('#spinner').removeClass('show');
                }
            }, 1);
        };
        spinner();

        // Back to top button
        $(window).scroll(function () {
            if ($(this).scrollTop() > 300) {
                $('.back-to-top').fadeIn('slow');
            } else {
                $('.back-to-top').fadeOut('slow');
            }
        });
        $('.back-to-top').click(function () {
            $('html, body').animate({ scrollTop: 0 }, 1500, 'easeInOutExpo');
            return false;
        });

        // Client-side search + featured filter (current page only)
        const productItems = Array.from(document.querySelectorAll('#productsContainer .product-item'));
        const filterButtons = document.querySelectorAll('.ff-btn-filter');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const noProductsMessage = document.getElementById('noProductsMessage');
        let activeFilter = 'all';

        function normalize(text) {
            return (text ?? '').toString().trim().toLowerCase();
        }

        function applyFilters() {
            const searchTerm = normalize(searchInput?.value);
            let visibleCount = 0;

            productItems.forEach(item => {
                const isFeatured = item.dataset.featured === 'true';
                const title = normalize(item.querySelector('.ff-product-title')?.innerText);
                const shortDesc = normalize(item.querySelector('.ff-product-description')?.innerText);

                const matchFeatured = activeFilter === 'all' || (activeFilter === 'featured' && isFeatured);
                const matchSearch = !searchTerm || title.includes(searchTerm) || shortDesc.includes(searchTerm);

                const isVisible = matchFeatured && matchSearch;
                item.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });

            if (noProductsMessage) {
                noProductsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeFilter = btn.dataset.filter ?? 'all';
                applyFilters();
            });
        });

        searchBtn?.addEventListener('click', applyFilters);
        searchInput?.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyFilters();
            }
        });

        applyFilters();

        // Category dropdown -> server filtering to fetch correct dataset
        const categorySelect = document.getElementById('categorySelect');
        const categoryToggle = document.getElementById('btnCategoryFilter');
        function applyCategorySelection() {
            const params = new URLSearchParams(window.location.search);
            if (categorySelect?.value) {
                params.set('categoryId', categorySelect.value);
            } else {
                params.delete('categoryId');
            }
            params.delete('page');
            const query = params.toString();
            const newUrl = query ? `${window.location.pathname}?${query}` : window.location.pathname;
            window.location.href = newUrl;
        }
        categorySelect?.addEventListener('change', applyCategorySelection);
        categoryToggle?.addEventListener('click', applyCategorySelection);

        // Cart functionality
        let isProcessingCart = false;
        let currentProductId = null;
        let currentVariantId = null;

        // Debug function to check CSRF token
        function checkCsrfToken() {
            const token = $('meta[name="X-CSRF-TOKEN"]').attr('content');
            console.log('CSRF Token:', token);
            return token;
        }

        // Debug page load
        console.log('Product Show page loaded');
        console.log('User authenticated:', @Html.Raw(Json.Serialize(isAuth)));
        checkCsrfToken();

        function showVariantModal(productId) {
            console.log('showVariantModal called with productId:', productId);
            if (isProcessingCart) return;

            isProcessingCart = true;
            currentProductId = productId;

            $.ajax({
                url: `/api/products/${productId}/variants`,
                method: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRF-TOKEN", $('meta[name="X-CSRF-TOKEN"]').attr('content'));
                },
                success: function (response) {
                    console.log('Variant modal success:', response);
                    if (response.variants && response.variants.length > 0) {
                        let content = `
                            <div class="text-center mb-3">
                                <h6 class="mb-3">${response.productName}</h6>
                                <p class="text-muted">Vui lòng chọn loại sản phẩm:</p>
                            </div>
                            <div class="variant-options">
                        `;

                        response.variants.forEach(function (variant) {
                            // Chuẩn hóa tồn kho (API có thể trả string)
                            const stockValue = Number(variant.stock ?? 0);
                            const outOfStock = !variant.isActive || stockValue <= 0;
                            if (!outOfStock) {
                                content += `
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio"
                                               name="variantId"
                                               id="variant_${variant.id}"
                                               value="${variant.id}"
                                               data-price="${variant.price}"
                                               data-stock="${stockValue}"
                                               data-active="${variant.isActive}">
                                        <label class="form-check-label" for="variant_${variant.id}">
                                            ${variant.variantName} - ${variant.price.toLocaleString('vi-VN')}đ
                                        </label>
                                    </div>
                                `;
                            } else {
                                content += `
                                    <div class="form-check mb-2" style="opacity: 0.6;">
                                        <input class="form-check-input" type="radio" disabled id="variant_${variant.id}" style="cursor: not-allowed;">
                                        <label class="form-check-label text-muted" for="variant_${variant.id}" style="cursor: not-allowed;">
                                            ${variant.variantName} - ${variant.price.toLocaleString('vi-VN')}đ <span class="text-danger">(Tạm hết hàng)</span>
                                        </label>
                                    </div>
                                `;
                            }
                        });

                        content += '</div>';
                        $('#variantModalContent').html(content);
                        $('#variantModal').modal('show');
                    } else {
                        // No variants, add directly
                        console.log('No variants found, adding directly to cart');
                        addToCart(productId, null);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Variant modal error:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    console.error('Status code:', xhr.status);
                    
                    let errorMessage = 'Không thể tải thông tin sản phẩm';
                    
                    if (xhr.status === 401) {
                        errorMessage = 'Vui lòng đăng nhập để xem thông tin sản phẩm';
                    } else if (xhr.status === 404) {
                        errorMessage = 'Sản phẩm không tồn tại';
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    $.toast({
                        heading: 'Lỗi',
                        text: errorMessage,
                        showHideTransition: 'slide',
                        icon: 'error',
                        position: 'top-right'
                    });
                },
                complete: function () {
                    isProcessingCart = false;
                }
            });
        }

        function addToCart(productId, variantId) {
            console.log('addToCart called with:', { productId, variantId });
            
            if (isProcessingCart) {
                console.log('Cart processing in progress, returning');
                return;
            }

            // Không cần kiểm tra đăng nhập - cho phép anonymous users

            isProcessingCart = true;

            // Prepare data with anti-forgery token
            const csrfToken = checkCsrfToken();
            
            // Use FormData for proper form binding
            const data = new FormData();
            data.append('id', productId);
            data.append('quantity', 1);
            data.append('variantId', variantId || '');
            
            console.log('Sending FormData:');
            for (let pair of data.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            console.log('CSRF Token:', csrfToken);

            // Use main endpoint (temporarily without auth requirement)
            const endpoint = '/add-product-from-view-detail';
            console.log('Using endpoint:', endpoint);
            console.log('Full request URL:', window.location.origin + endpoint);
            console.log('Request method: POST');
            console.log('Request data type: FormData');
            
            $.ajax({
                url: endpoint,
                method: 'POST',
                data: data,
                processData: false,
                contentType: false,
                xhrFields: {
                    withCredentials: true // Send cookies with the request
                },
                beforeSend: function (xhr) {
                    console.log('AJAX request started');
                },
                success: function (response) {
                    console.log('AJAX success:', response);
                    if (response.success) {
                        $.toast({
                            heading: 'Thành công',
                            text: response.message,
                            showHideTransition: 'slide',
                            icon: 'success',
                            position: 'top-right'
                        });

                        // Update cart count
                        updateCartCount();
                    } else {
                        $.toast({
                            heading: 'Lỗi',
                            text: response.message,
                            showHideTransition: 'slide',
                            icon: 'error',
                            position: 'top-right'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Add to cart error:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    console.error('Status code:', xhr.status);
                    
                    let errorMessage = 'Có lỗi xảy ra khi thêm vào giỏ hàng';
                    
                    if (xhr.status === 401) {
                        errorMessage = 'Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Bạn không có quyền thực hiện thao tác này';
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    $.toast({
                        heading: 'Lỗi',
                        text: errorMessage,
                        showHideTransition: 'slide',
                        icon: 'error',
                        position: 'top-right'
                    });
                },
                complete: function () {
                    isProcessingCart = false;
                    console.log('AJAX request completed');
                }
            });
        }

        function updateCartCount() {
            $.ajax({
                url: '/cart/count',
                method: 'GET',
                success: function (response) {
                    var $b = $('#sumCart');
                    if (!$b.length) return;
                    var n = Number(response?.count ?? 0);
                    $b.text(n);
                    $b.css('display', n > 0 ? 'inline-block' : 'none');
                }
            });
        }

        // Event handlers
        $(document).on('click', '.btnAddToCartHomepage', function (e) {
            e.preventDefault();
            console.log('Add to cart button clicked');
            const productId = $(this).data('product-id');
            console.log('Product ID:', productId);
            console.log('Button element:', this);
            console.log('Data attributes:', $(this).data());
            showVariantModal(productId);
        });

        $(document).on('click', '#confirmAddToCart', function () {
            console.log('Confirm add to cart clicked');
            const selectedVariant = $('input[name="variantId"]:checked');
            const variantId = selectedVariant.length > 0 ? selectedVariant.val() : null;
            console.log('Selected variant:', variantId);

            if (variantId) {
                // Double-check tồn kho ở client: nếu stock <= 0 thì không cho thêm
                const stockValue = Number(selectedVariant.data('stock') ?? 0);
                const isActive = String(selectedVariant.data('active')) === 'true';
                if (!isActive || stockValue <= 0) {
                    $.toast({
                        heading: 'Thông báo',
                        text: 'Biến thể này tạm hết hàng, vui lòng chọn loại khác.',
                        showHideTransition: 'slide',
                        icon: 'warning',
                        position: 'top-right'
                    });
                    return;
                }

                $('#variantModal').modal('hide');
                addToCart(currentProductId, variantId);
            } else {
                $.toast({
                    heading: 'Thông báo',
                    text: 'Vui lòng chọn loại sản phẩm',
                    showHideTransition: 'slide',
                    icon: 'warning',
                    position: 'top-right'
                });
            }
        });

        // Filter functionality
        $('.ff-btn-filter').click(function () {
            $('.ff-btn-filter').removeClass('active');
            $(this).addClass('active');

            const filter = $(this).data('filter');
            console.log('Filter clicked:', filter); // Debug
            filterProducts(filter);
        });

        // Category filter functionality
        $('#categorySelect').change(function () {
            const category = $(this).val();
            console.log('Category dropdown changed to:', category);
            
            // Cập nhật URL mà không reload trang
            const url = new URL(window.location.href);
            if (category) {
                url.searchParams.set('category', getCategoryNameFromId(category));
            } else {
                url.searchParams.delete('category');
            }
            window.history.replaceState({}, '', url);
            
            filterProductsByCategory(category);
        });
        
        // Hàm chuyển đổi từ category ID sang category name cho URL
        function getCategoryNameFromId(categoryId) {
            const reverseMapping = {
                '1': 'burger',
                '2': 'pizza', 
                '6': 'chicken',
                '7': 'drinks'
            };
            return reverseMapping[categoryId] || categoryId;
        }

        function filterProducts(filter) {
            console.log('Filtering by:', filter); // Debug
            let visibleCount = 0;
            
            $('.product-item').each(function () {
                const $item = $(this);
                let show = false;

                if (filter === 'all') {
                    show = true;
                } else if (filter === 'featured') {
                    const isFeatured = $item.data('featured');
                    console.log('Product featured status:', isFeatured); // Debug
                    show = isFeatured === 'true' || isFeatured === true;
                }

                if (show) {
                    $item.fadeIn(300);
                    visibleCount++;
                } else {
                    $item.fadeOut(300);
                }
            });
            
            console.log('Visible products after filter:', visibleCount); // Debug
            
            // Hiển thị thông báo nếu không có sản phẩm nào
            if (visibleCount === 0 && filter === 'featured') {
                showNoProductsMessage('Không có sản phẩm nổi bật nào');
            } else {
                hideNoProductsMessage();
            }
        }
        
        function showNoProductsMessage(message) {
            if ($('.no-products-message').length === 0) {
                $('#productsContainer').append(`
                    <div class="col-12 text-center no-products-message">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>${message}
                        </div>
                    </div>
                `);
            }
        }
        
        function hideNoProductsMessage() {
            $('.no-products-message').remove();
        }

        function filterProductsByCategory(category) {
            console.log('filterProductsByCategory called with category:', category, 'type:', typeof category);
            let visibleCount = 0;
            
            $('.product-item').each(function () {
                const $item = $(this);
                const productCategory = $item.data('category');
                let show = false;

                if (!category || category === '') {
                    show = true; // Show all if no category selected
                } else {
                    // Convert both to string for comparison
                    show = String(productCategory) === String(category);
                    console.log('Product category:', productCategory, '(' + typeof productCategory + ')', 
                               'Filter category:', category, '(' + typeof category + ')', 
                               'Show:', show);
                }

                if (show) {
                    $item.fadeIn();
                    visibleCount++;
                } else {
                    $item.fadeOut();
                }
            });
            
            console.log('Total visible products after filter:', visibleCount);
        }

        // Auto-filter by category from URL parameter
        function autoFilterByUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            if (category) {
                // Mapping từ URL parameter sang category ID (phải khớp với C# controller mapping)
                const categoryMapping = {
                    'burger': '1',     // Burger category ID
                    'pizza': '2',      // Pizza category ID  
                    'chicken': '6',    // Gà Rán category ID
                    'drinks': '7'      // Tacos category ID (this is what "Đồ Uống" maps to)
                };
                
                const mappedCategoryId = categoryMapping[category] || category;
                
                console.log('Auto-filtering by category:', category, '-> mapped to category ID:', mappedCategoryId);
                
                // Set the dropdown value
                $('#categorySelect').val(mappedCategoryId);
                // Filter products by category ID
                filterProductsByCategory(mappedCategoryId);
            }
        }

        // Call auto-filter on page load
        $(document).ready(function () {
            console.log('Product Show page loaded, checking for category filter...');
            console.log('Current URL:', window.location.href);
            console.log('URL search params:', window.location.search);
            
            // Log số lượng sản phẩm nổi bật
            const featuredCount = $('.product-item[data-featured="true"]').length;
            console.log('Total featured products found:', featuredCount);
            
            // Log tất cả sản phẩm và trạng thái featured của chúng
            $('.product-item').each(function () {
                const $item = $(this);
                const name = $item.find('.ff-product-title').text().trim();
                const isFeatured = $item.data('featured');
                const category = $item.data('category');
                console.log('Product:', name, '| Featured:', isFeatured, '| Category:', category);
            });
            
            autoFilterByUrl();
        });
    </script>
</body>

</html>